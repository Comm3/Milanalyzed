{
    "contents" : "# library(maptools)\nlibrary(dplyr)\nlibrary(stringdist)\nlibrary(rgdal)\nlibrary(ggplot2)\n\n\n\n# Load map ----------------------------------------------------------------\n\nmilan_qt <- readOGR(dsn = \"Dati/quartieri\", layer = \"NILZone\")\n\n\n# Deaths ------------------------------------------------------------------\n\n\ndecessi <- read.csv(file = \"Dati/dataset/Morti_quartiere_2003_2014.csv\", \n                    header = TRUE, \n                    sep = \";\", \n                    fileEncoding = \"latin1\")\n\ndecessi$Numerosità <- as.numeric(decessi$Numerosità)\nlevels(decessi$Quartiere) <- c(levels(decessi$Quartiere), \"Parco Sempione\")\ndecessi$Quartiere[decessi$Quartiere == \"\"] <- \"Parco Sempione\"\n\n# Colonna con i nomi dei quartieri presenti in tabella\nmilan_qt@data$DB_ID_NIL <- sapply(as.character(zone_sp@data$NIL),\n                                  # Custom function\n                                  str_match,\n                                  words = as.character(unique(decessi$Quartiere)))\n\n\ndecessi <- filter(decessi, Luogo_decesso == \"Milano\")  %>%\n  select(Anno_evento, Quartiere, Numerosità) %>%\n  group_by(Quartiere) %>%\n  summarize( decessi = sum(Numerosità))\n\nmilan_qt@data <- \n  left_join(milan_qt@data, decessi, by = c(\"DB_ID_NIL\" = \"Quartiere\"))\n\n\n\n# Births ------------------------------------------------------------------\n\n\nnascite <- read.csv(file = \"Dati/dataset/Nati_quartiere_2003_2014.csv\", \n                    header = TRUE, \n                    sep = \";\", \n                    fileEncoding = \"latin1\")\n\n# Converting to attribute to same type\nnascite$Numerosità <- as.numeric(nascite$Numerosità)\n\nlevels(nascite$Quartiere) <- c(levels(nascite$Quartiere), \"Parco Sempione\")\nnascite$Quartiere[nascite$Quartiere == \"\"] <- \"Parco Sempione\"\n\nnascite <- nascite %>%\n  filter(Luogo_nascita == \"Milano\")  %>%\n  select(Anno_evento, Quartiere, Numerosità) %>%\n  group_by(Quartiere) %>%\n  summarize(nascite = sum(Numerosità))\n\n\nmilan_qt@data <- \n  left_join(milan_qt@data, nascite, by = c(\"DB_ID_NIL\" = \"Quartiere\"))\n\n\n# Suddivisione per anagrafica ----------------------------\n\npopolazione <- read.csv(file = \"Dati/dataset/pop_sto_quartiere_1999-2014.csv\", \n                        header = TRUE, \n                        sep = \";\", \n                        fileEncoding = \"latin1\") %>%\n  mutate(X2014 = as.numeric(X2014),\n         # Quartiere = as.character(Quartiere),\n         Eta = as.integer(Eta))\n\n# Cittadinanza =====================\n\nmilan_qt@data <- \n  left_join(\n    milan_qt@data,\n    select(popolazione, Quartiere, Cittadinanza, X2014) %>%\n      group_by(Quartiere) %>%\n      summarise(cittadini = sum(X2014)),\n    by = c(\"DB_ID_NIL\" = \"Quartiere\")\n  )\n  \n\nmilan_qt@data <- \n  left_join(\n    milan_qt@data,\n    filter(popolazione, Cittadinanza != \"Italia\") %>%\n      select(Quartiere, seconda_cittadinanza = Cittadinanza, X2014) %>%\n      group_by(Quartiere, seconda_cittadinanza) %>%\n      summarise(secondi_cittadini = sum(X2014)) %>%\n      filter(secondi_cittadini == max(secondi_cittadini)) %>%\n      replace(is.na(.), 0),\n    by = c(\"DB_ID_NIL\" = \"Quartiere\")\n  )\n\n\n# Popolazione per sesso ed eta ===============\n\nmilan_qt@data <- \n  left_join(milan_qt@data,\n    filter(popolazione, Eta >= 25 & Eta <= 30 ) %>%\n    transmute(Quartiere,\n              Cittadinanza,\n              Genere = ifelse(Genere == \"Femmine\",\n                              \"Femmine_giovani\",\n                              \"Uomini_giovani\"),\n              X2014) %>%\n    group_by(Quartiere, Genere) %>%\n    summarise(pop = sum(X2014)) %>%\n    spread(Genere, pop) %>%\n    replace(is.na(.), 0),\n  by = c(\"DB_ID_NIL\" = \"Quartiere\")\n  )\n\nmilan_qt@data <- \n  left_join(milan_qt@data,\n            filter(popolazione, Eta >= 25 & Eta <= 30 & Cittadinanza == \"Italia\") %>%\n              transmute(Quartiere,\n                        Cittadinanza,\n                        Genere = ifelse(Genere == \"Femmine\",\n                                        \"Femmine_giovani_it\",\n                                        \"Uomini_giovani_it\"),\n                        X2014) %>%\n              group_by(Quartiere, Genere) %>%\n              summarise(pop = sum(X2014)) %>%\n              spread(Genere, pop) %>%\n              replace(is.na(.), 0),\n            by = c(\"DB_ID_NIL\" = \"Quartiere\")\n  )\n\n\n",
    "created" : 1449171085557.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3761893581",
    "id" : "2FDEFE4E",
    "lastKnownWriteTime" : 1449180817,
    "path" : "~/Development/Milanalytics/Merge_data_to_map.R",
    "project_path" : "Merge_data_to_map.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}